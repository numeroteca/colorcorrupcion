<!DOCTYPE html>
<html>
  <head>
		<title>Color Corrupci&oacute;n</title>
		<script type="text/javascript" src="js/d3.min.js"></script>
		<script type="text/javascript" src="http://code.jquery.com/jquery-1.10.2.js"></script>
		<script type="text/javascript" src="js/bootstrap.min.js"></script>
		<link rel="stylesheet" href="css/bootstrap.min.css">
		<style type="text/css">

		svg {
			width: 1300px;
			height: 400px;
			border: solid 1px #ccc;
			font: 10px sans-serif;
			shape-rendering: crispEdges;
		}
		rect:hover {
			cursor:pointer;
			opacity: 0.4;
		}
		.rule line:hover {
			stroke:#000 !important;
			cursor:pointer;
		}
		.cis-line:hover {
			stroke:#444;
			cursor:pointer;
		}

    </style>
  </head>
  <body class="container-fluid">
  	<div class="row">
  		<div class="col-md-12">
				<h1>El Color de la Corrupci&oacute;n
				</h1>
				<p>Cobertura de corrupci&oacute;n en portadas de prensa.</p>
				<h2>Superficie dedicada en portada a casos de corrupci&oacute;n</h2>
				<p>Clasificaci&oacute;n por partido pol&iacute;tico o instituci&oacute;n. Datos mensuales 2013-2015.</p>
				<h5>Leyenda: 
					<span class="label" style="background-color:blue">PP</span> 
					<span class="label" style="background-color:red">PSOE</span> 
					<span class="label" style="background-color:orange">CiU</span> 
					<span class="label" style="background-color:darkgreen">Casa Real</span> 
					<span class="label" style="background-color:lime">Bankia</span> 
					<span class="label" style="background-color:#FBBBB9">UGT-A y CCOO</span>
					<span class="label" style="background-color:#9e398b">Podemos</span>
					<span class="label" style="background-color:grey">Otros</span> L&iacute;nea: Corrupci&oacute;n y fraude como problema (Bar&oacute;metro CIS)
				</h5>
				<ul class="nav nav-pills" role="menu">
					<li class="disabled"><a href="#">Selecciona un peri&oacute;dico</a></li>
					<li><a class="m" value="Total mes" href="#">Media de todos los peri&oacute;dicos</a></li>
					<li><a class="m" value="El Pais" href="#">El Pa&iacute;s</a></li>
					<li><a class="m" value="El Mundo" href="#">El Mundo</a></li>
					<li><a class="m" value="ABC" href="#">ABC</a></li>
					<li><a class="m" value="La Razon" href="#">La Raz&oacute;n</a></li>
					<li><a class="m" value="La Gaceta" href="#">La Gaceta</a></li>
					<li><a class="m" value="La Vanguardia" href="#">La Vanguardia</a></li>
					<li><a class="m" value="El Periodico" href="#">El Peri&oacute;dico</a></li>
					<li><a class="m" value="Ara" href="#">Ara</a></li>
					<!--<li><a class="m" value="Total dia" href="#">Por d&iacute;a todos</a></li>-->
				</ul>
				<div id="datavis"></div>
    		<script type="text/javascript">
//On click, update with new data

//initially based on http://bl.ocks.org/mbostock/1134768 and http://bl.ocks.org/anupsavvy/9513382
var w = 1300,
    h = 400,
    p = [20, 170, 30, 20],
    x = d3.scale.ordinal().rangeRoundBands([0, w - p[1] - p[3]]), //https://github.com/mbostock/d3/wiki/Ordinal-Scales#ordinal_rangeRoundBands
    y = d3.scale.linear().range([0, h - p[0] - p[2]]),
    colors = ["blue","red", "orange","darkgreen","lime","#FBBBB9","grey","grey","#9e398b"],
    color = d3.scale.ordinal().range(colors),
    //parties = ['PP','PSOE','CiU','Casa Real','Bankia','UGT-A y CCOO','Otros'];
    //parties = {'PP':"blue",'PSOE':"red",'CiU':"orange",'Casa Real':"darkgreen",'Bankia':"lime",'UGT-A y CCOO':"#FBBBB9",'Otros':"grey};
    //parse = d3.time.format("%m-%Y").parse,
    format = d3.time.format("%b");
    var formato = d3.time.format("%m-%Y");
    //parse = d3.time.format("%Y-%m-%d").parse
    var yCIS = d3.scale.linear().range([0, h - p[0] - p[2]]); //scale for CIS data
    var ySum = d3.scale.linear().range([0, h - p[0] - p[2]]); //scale for CIS data

var svg = d3.select("#datavis").append("svg:svg")
    .attr("width", w)
    .attr("height", h)
  .append("svg:g")
    .attr("transform", "translate(" + p[3] + "," + (h - p[2]) + ")");

//Set up stack method
var stack = d3.layout.stack();

//console.log("aaa");

//var str = "data/perMonthElMundo.json";	
//console.log("str",str);

//On click, update with new data
d3.selectAll(".m").on("click", function() {
	var date = this.getAttribute("value");
	//console.log("this",this.getAttribute("value"));
	//console.log("date",date);
	var str = "data/perMonthElMundo.json";
	//console.log("str 0",str);
	if(date == "El Pais"){
		str = "data/perMonthElPais.json";
	}else if(date == "El Mundo"){
		str = "data/perMonthElMundo.json";
	}else if(date == "ABC"){
		str = "data/perMonthABC.json";
	}else if(date == "La Razon"){
		str = "data/perMonthLaRazon.json";
	}else if(date == "La Gaceta"){
		str = "data/perMonthLaGaceta.json";
	}else if(date == "La Vanguardia"){
		str = "data/perMonthLaVanguardia.json";
	}else if(date == "El Periodico"){
		str = "data/perMonthElPeriodico.json";
	}else if(date == "Ara"){
		str = "data/perMonthAra.json";
	}else if(date == "Total mes"){
		str = "data/perMonthTotal.json";
	//}else if(date == "Total dia"){
	//	str = "data/perDayTotal.json";
	}else{
		str = "data/perMonthLaVanguardia.json";
	}
	//console.log("str 1",str);


//d3.csv("crimea.csv", function(crimea) {
d3.json(str, function(total) { //Reads json file 'data/perMonthElMundo.json'

console.log(total);

var sum = total['sum'];
console.log(sum);

media = total['media'];
console.log("media",media);

total = total['data'];
for ( var i = 0; i < total.length; i++ ){
	total[i].sort(function(a,b){
		// Turn your strings into dates, and then subtract them
		// to get a value that is either negative, positive, or zero.
		return new Date(a.x) - new Date(b.x);
	});
}

//For json
dataset = total;
stack(dataset);
console.log("stack(dataset) ",dataset);

// Compute the x-domain (by date) and y-domain (by top).
x.domain(	dataset[0].map(function(d) { return d.x; }) ); //coge la primera de las n arrays, podÅ•ia ser 1 o 2 tambien
y.domain([
	0, //valor minimo
	14 //TODO calculate the max value (y0) of all the possible arrays to keep y scale constant
	/*d3.max(
		dataset[dataset.length - 1], function(d) { return d.y0 + d.y; console.log(d.y0 + d.y);} //coge la array ultima que ya tienen todos los valors acumulados
	) */ //valor maximo
]); //usa la ultima array, la que tiene los valores de las otras ya acumulados para calcular el maximos valos de y

//Labels in x axis
svg.selectAll("text")
   .data(dataset[0])
   .enter()
   .append("text")
   .text(function(d) {
        return String(formato(new Date(d.x)));
   })
   .attr("x", function(d, i) {
        //return i * (w / dataset[0].length);
        return x(d.x);
   })
   .attr("y", 15)
   .style("font-size","8px");

//Creates groups for codes. Every rectangle with a color (=code or party) is in a svg group
groups = svg.selectAll(".party").data(dataset);
groups.enter().append("g") //adds groups and asig color to every fill
        .attr("class","party")
        .style("fill",function(d,i) {
            return color(i);
        });
//Removes rectangles to insert them again (cleans previous drawn rectangles(
groups.selectAll("rect").data(function(d){return d;}).remove();

//Adds rectangles the stack bars
rect = groups.selectAll("rect").data(function(d){return d;});

rect.enter()
  .append("rect")
  //.attr("x",function(d,i) { return i*w/dataset[0].length-20; })
  .attr("x", function(d) { return x(d.x); })
  .attr("y", function(d) { return -y(d.y0) - y(d.y); })
  .attr("width",(w - p[1] - p[3])/(dataset[0].length*1.15))
  .attr("height", function(d) { return y(d.y); })
  .attr("title",function(d) { return d.party + ": " + d.y.toPrecision(3) + " portadas en este mes\n" + formato(new Date(d.x)); })
  .style("fill-opacity",1);

//Adds legend
/*legend = svg.selectAll("rect");

var legend = svg.append("rect")
  //.attr("x",function(d,i) { return i*w/dataset[0].length-20; })
  .attr("x", function(d,i) { return i*10; })
  .attr("y", function(d,i) { return h; })
  .attr("width",20)
  .attr("height",20)
  .attr("fill","#f00")
  .style("fill-opacity",1);
*/
// Add y-axis rules.
var rule = svg.selectAll("g.rule")
    .data(y.ticks(5))
  .enter().append("svg:g")
    .attr("class", "rule")
    .attr("transform", function(d) { return "translate(0," + -y(d) + ")"; });

rule.append("svg:line")
    .attr("x2", w - p[1] - p[3])
    .style("stroke", function(d) { return d ? "#fff" : "#000"; })
    .style("stroke-width", 1)
    .style("stroke-opacity", function(d) { return d ? .7 : null; });

rule.append("svg:text")
    .attr("x", -15)
    .attr("dy", ".35em")
    .text(d3.format(",d"));

d3.select(".explain").remove();
      
  var explain = svg.append("svg:g").attr("class","explain");
  
  explain.append("svg:text")
      .attr("x", w - p[2] -120)
      .attr("y", -h + p[0] + 30)
      .text("Numero de portadas/mes");
  explain.append("svg:text")
      .attr("x", w - p[2] -120)
      .attr("y", -h + p[0] +50 )
      .text("1 = superficie 1 portada");
  explain.append("svg:text")
      .attr("x", w - p[2] -120)
      .attr("y", -h + p[0] + 70 )
      .text("% respuestas CIS");
  
	d3.select(".medianame").remove();
	
  var mediaName = svg.append("svg:text")
    .attr("x", 50)
    .attr("y", -h + p[0] + 15)
    .attr("dy", "1em")
    .attr("class", "medianame")
    .attr("text-anchor", "right")
    .style("font-size","16px")
    .text(media);

//Sum bar
ySum.domain([0,140]);

dataSum = sum;
stack(dataSum);

stack(dataSum);

console.log("dataSumStack",dataSum);

//Adds the sum stacked bar
groupsSum = svg.selectAll(".sum").data(dataSum);
groupsSum.enter().append("g") //adds groups and asig color to every fill
        .attr("class","sum")
        .style("fill",function(d,i) {
            return color(i);
        });

//Removes rectangles to insert them again (cleans previous drawn rectangles(
groupsSum.selectAll("rect").data(function(d){return d;}).remove();
        
//Adds rectangles the stack bars
rectSum = groupsSum.selectAll("rect").data(function(d){return d;});

rectSum.enter()
  .append("rect")
  //.attr("x",function(d,i) { return i*w/dataset[0].length-20; })
  .attr("x", w - p[2] -120)
  .attr("y", function(d) { return -ySum(d.y0) - ySum(d.y); })
  .attr("width",60)
  .attr("height", function(d) { return ySum(d.y); })
  .attr("title",function(d) { return d.party + ": " + d.y.toPrecision(3) + " portadas en total"; })
  .style("fill-opacity",1);

svg.append("svg:text")
  .attr("x", w - p[2] -100)
  .attr("y", 15 )
  .text("Total");


//Data from CIS on corruption perception
yCIS.domain([0,70]);
var datosCIS = [
	{x:"2013-01-01",y:17.7},
	{x:"2013-02-01",y:40.0},
	{x:"2013-03-01",y:44.5},
	{x:"2013-04-01",y:39.3},
	{x:"2013-05-01",y:30.7},
	{x:"2013-06-01",y:32.5},
	{x:"2013-07-01",y:37.4},
	{x:"2013-08-01",y:37.2},//invented value
	{x:"2013-09-01",y:37.1},
	{x:"2013-10-01",y:31.3},
	{x:"2013-11-01",y:31.8},
	{x:"2013-12-01",y:37.6},
	{x:"2014-01-01",y:39.5},
	{x:"2014-02-01",y:44.2},
	{x:"2014-03-01",y:41.0},
	{x:"2014-04-01",y:36.3},
	{x:"2014-05-01",y:35.7},
	{x:"2014-06-01",y:38.8},
	{x:"2014-07-01",y:41.5},
	{x:"2014-08-01",y:41.9},//invented value
	{x:"2014-09-01",y:42.7},
	{x:"2014-10-01",y:42.3},
	{x:"2014-11-01",y:63.8},
	{x:"2014-12-01",y:60.0},
	{x:"2015-01-01",y:55.5},
	{x:"2015-02-01",y:48.5},
]
//console.log("datosCIS[2]['x']",x(datosCIS[2]['x']));
//console.log("yCIS(datosCIS[0]['y'])",yCIS(datosCIS[1]['y']));
//console.log("ddd",w/(dataset[0].length));

//Adds CIS line
var barWidth = (w - p[1] - p[3])/(dataset[0].length);
var lineFunc = d3.svg.line()
  .x(function(d,i) { return (i+1)*barWidth-barWidth/2; })
  .y(function(d) {
    return -yCIS(d.y);
  })
  .interpolate('linear');

svg.append('svg:path')
  .attr('d', lineFunc(datosCIS))
  .attr('stroke', '#AAAAAA')
  .attr('class', 'cis-line')
  .attr('title', 'Corrupcion y fraude como problema (Barometro CIS)')
  .attr('stroke-width', 4)
  .attr('fill', 'none');

  // Add y-axis for CIS rules.
  var ruleccis = svg.selectAll("g.rulecis")
      .data(yCIS.ticks(4))
    .enter().append("svg:g")
      .attr("class", "rulecis")
      .attr("transform", function(d) { return "translate(0," + -yCIS(d) + ")"; });

  ruleccis.append("svg:text")
      .attr("x", w - p[1] - p[3] + 5)
      .attr("dy", ".35em")
      .text(d3.format());
	ruleccis.append("svg:text")
			.attr("x", w - p[1] - p[3] + 18)
			.attr("dy", ".35em")
			.text(" %");

});
});//end on click
    		</script>
    		
    	<p>M&aacute;s informaci&oacute;n sobre este proyecto en <a href="http://colorcorrupcion.tumblr.com/">colorcorrupcion.tumblr.com/</a> y en <a href="http://numeroteca.org/tag/colorcorrupcion/">numeroteca.org > colororrupci&oacute;n</a><br>
    	</p>
    	<h3>Datos</h3>
    	<p>Puedes ver todos lo meses codificados en <a href="http://pageonex.com/threads/search_by_category?q=colorcorrupci%C3%B3n">PageOneX > Colorcorrupci&oacute;n.</a><br><img src="http://numeroteca.org/wp-content/uploads/2014/05/colorcorrupcion-primera-mitad-a%C3%B1o-2013-1024x61.jpg"></p>
    	<p><strong>2015</strong> <a href="http://pageonex.com/numeroteca/corrupcion-espana-enero-2015/">Enero</a>&nbsp;<a href="http://pageonex.com/numeroteca/corrupcion-espana-febrero-2015/">Febrero</a>&nbsp;<a href="http://pageonex.com/numeroteca/corrupcion-espana-marzo-2015/">Marzo</a>

<p><strong>2014</strong> <a href="http://pageonex.com/numeroteca/corrupcion-espana-enero-2014/">Enero</a>&nbsp;<a href="http://pageonex.com/numeroteca/corrupcion-espana-febrero-2014/">Febrero</a>&nbsp;<a href="http://pageonex.com/numeroteca/corrupcion-espana-marzo-2014/">Marzo</a>&nbsp;<a href="http://pageonex.com/numeroteca/corrupcion-espana-abril-2014/">Abril</a>&nbsp;<a href="http://pageonex.com/numeroteca/corrupcion-espana-mayo-2013/">Mayo</a>&nbsp;<a href="http://pageonex.com/numeroteca/corrupcion-espana-junio-2014/">Junio</a>&nbsp;<a href="http://pageonex.com/numeroteca/corrupcion-espana-julio-2014/">Julio</a>&nbsp;<a href="http://pageonex.com/numeroteca/corrupcion-espana-agosto-2014/&amp;sa=D&amp;sntz=1&amp;usg=AFQjCNGIpHW6ywyWzYy_ETFAc84XUnvoOg">Agosto</a>&nbsp;<a href="http://pageonex.com/numeroteca/corrupcion-espana-septiembre-2014/">Septiembre</a>&nbsp;<a href="http://pageonex.com/numeroteca/corrupcion-espana-octubre-2014/">Octubre</a>&nbsp;<a href="http://pageonex.com/numeroteca/corrupcion-espana-noviembre-2014/">Noviembre</a>&nbsp;<a href="http://pageonex.com/numeroteca/corrupcion-espana-diciembre-2014/">Diciembre</a></p>

<p><strong>2013</strong> <a href="http://pageonex.com/numeroteca/corrupcion-spain-enero-2013/">Enero</a>&nbsp;<a href="http://pageonex.com/numeroteca/colorcorrupcion-espana-febrero-2013/">Febrero</a>&nbsp;<a href="http://pageonex.com/numeroteca/corrupcion-espana-marzo-2013/">Marzo</a>&nbsp;<a href="http://pageonex.com/numeroteca/corrupcion-espana-abril-2013/">Abril</a>&nbsp;<a href="http://pageonex.com/numeroteca/corrupcion-espana-mayo-2013/">Mayo</a>&nbsp;<a href="http://pageonex.com/numeroteca/corrupcion-espana-junio-2013/">Junio</a>&nbsp;<a href="http://pageonex.com/numeroteca/corrupcion-espana-julio-2013/">Julio</a>&nbsp;<a href="http://pageonex.com/numeroteca/corrupcion-espana-agosto-2013/">Agosto</a>&nbsp;<a href="http://pageonex.com/numeroteca/corrupcion-espana-septiembre-2013/">Septiembre</a>&nbsp;<a href="http://pageonex.com/numeroteca/corrupcion-espana-octubre-2013/">Octubre</a>&nbsp;<a href="http://pageonex.com/numeroteca/corrupcion-espana-noviembre-2013/">Noviembre</a>&nbsp;<a href="http://pageonex.com/numeroteca/corrupcion-espana-diciembre-2013/">Diciembre</a>&nbsp;</p>
    	<p>Datos <a href="http://www.cis.es/opencms/-Archivos/Indicadores/documentos_html/TresProblemas.html">Bar&oacute;metro CIS</a>.</p>
    	<p>Visualizaci&oacute;n de datos realizada por Pablo Rey Maz&oacute;n. numeroteca.org
    	
    	</p>
    	</div>
    </div>
  </body>
</html>

