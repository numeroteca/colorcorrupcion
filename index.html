<!DOCTYPE html>
<html>
  <head>
		<title>PageOneX Color Corrupci&oacute;n</title>
		<script type="text/javascript" src="js/d3.v2.js"></script>
		<script type="text/javascript" src="http://code.jquery.com/jquery-1.10.2.js"></script>
		<script type="text/javascript" src="js/bootstrap.min.js"></script>
		<link rel="stylesheet" href="css/bootstrap.min.css">
		<style type="text/css">

		svg {
			width: 1500px;
			height: 400px;
			border: solid 1px #ccc;
			font: 10px sans-serif;
			shape-rendering: crispEdges;
		}
		rect:hover {
			cursor:pointer;
			opacity: 0.4;
		}

    </style>
  </head>
  <body class="container-fluid">
  	<div class="row">
  		<div class="col-md-12">
				<h1>El Color de la Corrupci&oacute;n
				</h1>
				<p>Cobertura de corrupci&oacute;n en portadas de prensa.</p>
				<h5>Leyenda: 
					<span class="label" style="background-color:blue">PP</span> 
					<span class="label" style="background-color:red">PSOE</span> 
					<span class="label" style="background-color:orange">CiU</span> 
					<span class="label" style="background-color:darkgreen">Casa Real</span> 
					<span class="label" style="background-color:lime">Bankia</span> 
					<span class="label" style="background-color:#FBBBB9">UGT-A y CCOO</span> 
					<span class="label" style="background-color:grey">Otros</span> L&iacute;nea: Corrupci&oacute;n y fraude como problema (Bar&oacute;metro CIS)
				</h5>
				<ul class="nav nav-pills" role="menu">
					<li class="disabled"><a href="#">Selecciona un peri&oacute;dico</a></li>
					<li><a class="m" value="Total mes" href="#">Media de todos los peri&oacute;dicos</a></li>
					<li><a class="m" value="El Pais" href="#">El Pa&iacute;s</a></li>
					<li><a class="m" value="El Mundo" href="#">El Mundo</a></li>
					<li><a class="m" value="ABC" href="#">ABC</a></li>
					<li><a class="m" value="La Razon" href="#">La Raz&oacute;n</a></li>
					<li><a class="m" value="La Gaceta" href="#">La Gaceta</a></li>
					<li><a class="m" value="La Vanguardia" href="#">La Vanguardia</a></li>
					<li><a class="m" value="El Periodico" href="#">El Peri&oacute;dico</a></li>
					<li><a class="m" value="Ara" href="#">Ara</a></li>
					<!--<li><a class="m" value="Total dia" href="#">Por d&iacute;a todos</a></li>-->
				</ul>
				<div id="datavis"></div>
    		<script type="text/javascript">
//On click, update with new data

//initially based on http://bl.ocks.org/mbostock/1134768 and http://bl.ocks.org/anupsavvy/9513382
var w = 1500,
    h = 400,
    p = [20, 170, 30, 20],
    x = d3.scale.ordinal().rangeRoundBands([0, w - p[1] - p[3]]), //https://github.com/mbostock/d3/wiki/Ordinal-Scales#ordinal_rangeRoundBands
    y = d3.scale.linear().range([0, h - p[0] - p[2]]),
    colors = ["blue", "red", "orange","darkgreen","lime","#FBBBB9","grey"],
    color = d3.scale.ordinal().range(colors),
    parties = ['PP','PSOE','CiU','Casa Real','Bankia','UGT-A y CCOO','Otros'];
    //parties = {'PP':"blue",'PSOE':"red",'CiU':"orange",'Casa Real':"darkgreen",'Bankia':"lime",'UGT-A y CCOO':"#FBBBB9",'Otros':"grey};
    //parse = d3.time.format("%m-%Y").parse,
    format = d3.time.format("%b");
    var formato = d3.time.format("%m-%Y");
    //parse = d3.time.format("%Y-%m-%d").parse
    var yCIS = d3.scale.linear().range([0, h - p[0] - p[2]]);

var svg = d3.select("#datavis").append("svg:svg")
    .attr("width", w)
    .attr("height", h)
  .append("svg:g")
    .attr("transform", "translate(" + p[3] + "," + (h - p[2]) + ")");

//Set up stack method
var stack = d3.layout.stack();

console.log("aaa");

var str = "data/perMonthElMundo.json";	
console.log("str",str);

//On click, update with new data
d3.selectAll(".m").on("click", function() {
	var date = this.getAttribute("value");
	//console.log("this",this.getAttribute("value"));
	console.log("date",date);
	var str = "data/perMonthElMundo.json";
	console.log("str 0",str);
	if(date == "El Pais"){
		str = "data/perMonthElPais.json";
	}else if(date == "El Mundo"){
		str = "data/perMonthElMundo.json";
	}else if(date == "ABC"){
		str = "data/perMonthABC.json";
	}else if(date == "La Razon"){
		str = "data/perMonthLaRazon.json";
	}else if(date == "La Gaceta"){
		str = "data/perMonthLaGaceta.json";
	}else if(date == "La Vanguardia"){
		str = "data/perMonthLaVanguardia.json";
	}else if(date == "El Periodico"){
		str = "data/perMonthElPeriodico.json";
	}else if(date == "Ara"){
		str = "data/perMonthAra.json";
	}else if(date == "Total mes"){
		str = "data/perMonthTotal.json";
	//}else if(date == "Total dia"){
	//	str = "data/perDayTotal.json";
	}else{
		str = "data/perMonthLaVanguardia.json";
	}
	console.log("str 1",str);


//d3.csv("crimea.csv", function(crimea) {
d3.json(str, function(total) { //Reads json file 'data/perMonthElMundo.json'

console.log(total);

media = total['media'];
console.log("media",media);

total = total['data'];
for ( var i = 0; i < total.length; i++ ){
	total[i].sort(function(a,b){
		// Turn your strings into dates, and then subtract them
		// to get a value that is either negative, positive, or zero.
		return new Date(a.x) - new Date(b.x);
	});
}

//For json
dataset = total;
stack(dataset);
console.log("stack(dataset) ",dataset);

// Compute the x-domain (by date) and y-domain (by top).
x.domain(	dataset[0].map(function(d) { return d.x; }) ); //coge la primera de las n arrays, podÅ•ia ser 1 o 2 tambien
y.domain([
	0, //valor minimo
	14 //TODO calculate the max value (y0) of all the possible arrays to keep y scale constant
	/*d3.max(
		dataset[dataset.length - 1], function(d) { return d.y0 + d.y; console.log(d.y0 + d.y);} //coge la array ultima que ya tienen todos los valors acumulados
	) */ //valor maximo
]); //usa la ultima array, la que tiene los valores de las otras ya acumulados para calcular el maximos valos de y

//LAbel in x axis
svg.selectAll("text")
   .data(dataset[0])
   .enter()
   .append("text")
   .text(function(d) {
        return formato(new Date(d.x));
   })
   .attr("x", function(d, i) {
        //return i * (w / dataset[0].length);
        return x(d.x);
   })
   .attr("y", 15);

groups = svg.selectAll(".cause").data(dataset);
groups.enter().append("g")
        .attr("class","cause")
        .style("fill",function(d,i) {
            return color(i);
        });

groups.selectAll("rect").data(function(d){return d;}).remove();

rect = groups.selectAll("rect").data(function(d){return d;});

rect.enter()
  .append("rect")
  //.attr("x",function(d,i) { return i*w/dataset[0].length-20; })
  .attr("x", function(d) { return x(d.x); })
  .attr("y", function(d) { return -y(d.y0) - y(d.y); })
  .attr("width",(w - p[1] - p[3])/(dataset[0].length*1.15))
  .attr("height", function(d) { return y(d.y); })
  .attr("title",function(d) { return d.party + ": " + d.y.toPrecision(3) + " portadas en este mes\n" + formato(new Date(d.x)); })
  .style("fill-opacity",1);

legend = svg.selectAll("rect");

var legend = svg.append("rect")
  //.attr("x",function(d,i) { return i*w/dataset[0].length-20; })
  .attr("x", function(d,i) { return i*10; })
  .attr("y", function(d,i) { return h; })
  .attr("width",20)
  .attr("height",20)
  .attr("fill","#f00")
  .style("fill-opacity",1);

  // Add a label per date.
  var label = svg.selectAll("text")
      .data(x.domain())
    .enter().append("svg:text")
      .attr("x", function(d) { return x(d) + x.rangeBand() / 2; })
      //.attr("x",function(d,i) { return i*w/dataset[0].length-20; })
      .attr("y", 6)
      .attr("text-anchor", "middle")
      .attr("dy", ".71em")
      //.text(function(d) { return month(d); });
      //.text(format());
      .text("-");

  // Add y-axis rules.
  var rule = svg.selectAll("g.rule")
      .data(y.ticks(5))
    .enter().append("svg:g")
      .attr("class", "rule")
      .attr("transform", function(d) { return "translate(0," + -y(d) + ")"; });

  rule.append("svg:line")
      .attr("x2", w - p[1] - p[3])
      .style("stroke", function(d) { return d ? "#fff" : "#000"; })
      .style("stroke-opacity", function(d) { return d ? .7 : null; });

  rule.append("svg:text")
      .attr("x", w - p[1] - p[3] + 6)
      .attr("dy", ".35em")
      .text(d3.format(",d"));
  
  d3.select(".explain").remove();
      
  var explain = svg.append("svg:g").attr("class","explain");
  
  explain.append("svg:text")
      .attr("x", w - p[2] -120)
      .attr("y", -h + p[0] + 30)
      .text("Numero de portadas/mes");
  explain.append("svg:text")
      .attr("x", w - p[2] -120)
      .attr("y", -h + p[0] +50 )
      .text("1 = 1 portada");
  
	d3.select(".medianame").remove();
	
  var mediaName = svg.append("svg:text")
    .attr("x", 0)
    .attr("y", -h + p[0] + 30)
    .attr("dy", "1em")
    .attr("class", "medianame")
    .attr("text-anchor", "right")
    .style("font-size","16px")
    .text(media);
    
    
yCIS.domain([0,70]);
var datosCIS = [
	{x:"2013-01-01",y:17.7},
	{x:"2013-02-01",y:40.0},
	{x:"2013-03-01",y:44.5},
	{x:"2013-04-01",y:39.3},
	{x:"2013-05-01",y:30.7},
	{x:"2013-06-01",y:32.5},
	{x:"2013-07-01",y:37.4},
	{x:"2013-08-01",y:37.2},//invented value
	{x:"2013-09-01",y:37.1},
	{x:"2013-10-01",y:31.3},
	{x:"2013-11-01",y:31.8},
	{x:"2013-12-01",y:37.6},
	{x:"2014-01-01",y:39.5},
	{x:"2014-02-01",y:44.2},
	{x:"2014-03-01",y:41.0},
	{x:"2014-04-01",y:36.3},
	{x:"2014-05-01",y:35.7},
	{x:"2014-06-01",y:38.8},
	{x:"2014-07-01",y:41.5},
	{x:"2014-08-01",y:41.9},//invented value
	{x:"2014-09-01",y:42.7},
	{x:"2014-10-01",y:42.3},
	{x:"2014-11-01",y:63.8},
	{x:"2014-12-01",y:60.0},
]
console.log("datosCIS[2]['x']",x(datosCIS[2]['x']));
console.log("yCIS(datosCIS[0]['y'])",yCIS(datosCIS[1]['y']));
console.log("ddd",w/(dataset[0].length));
var barWidth = (w - p[1] - p[3])/(dataset[0].length);

var lineFunc = d3.svg.line()
  .x(function(d,i) { return (i+1)*barWidth-barWidth/2; })
  .y(function(d) {
    return -yCIS(d.y);
  })
  .interpolate('linear');

svg.append('svg:path')
  .attr('d', lineFunc(datosCIS))
  .attr('stroke', 'black')
  .attr('stroke-width', 4)
  .attr('fill', 'none');

});

});//end on click
    		</script>
    	
    	<p>Puedes ver todos lo meses codificados en <a href="http://pageonex.com/threads/search_by_category?q=colorcorrupci%C3%B3n">PageOneX > Colorcorrupci&oacute;n.</a></p>
    	</div>
    </div>
  </body>
</html>

