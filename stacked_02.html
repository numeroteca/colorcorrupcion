<!DOCTYPE html>
<html>
  <head>
    <title>PageOneX Color Corrupci√≥n</title>
    <script type="text/javascript" src="http://mbostock.github.com/d3/d3.js?1.29.1"></script>
    <script type="text/javascript" src="http://mbostock.github.com/d3/d3.layout.js?1.29.1"></script>
    <script type="text/javascript" src="http://mbostock.github.com/d3/d3.time.js?1.29.1"></script>
    <script type="text/javascript" src="http://mbostock.github.com/d3/d3.csv.js?1.29.1"></script>
    <script type="text/javascript" src="http://code.jquery.com/jquery-1.10.2.js"></script>
    <style type="text/css">

    </style>
  </head>
  <body>
    <script type="text/javascript">

//d3.csv("crimea.csv", function(crimea) {
d3.json("total20132014.json", function(megajason) { //2013total.json

console.log(megajason);//TODO reorder by date

var parties = ['PP','PSOE','CiU','Casa Real','Bankia','UGT-A y CCOO','Otros'];
total = [];
for ( var i = 0; i < parties.length; i++ ) {
	total.push([]);
}

for (var key in megajason) { //itera por la unica matriz que hay: data
	var test = (megajason[key]);
	//console.log(test);
	for (var key in test) { //itera por los dias
		//console.log(key); //el dia
		//console.log(test[key]["Total"]);
		theDay = key;
		var totalday = test[key]["Total"]; //el objeto "Total" de cada dia. Si se cambia Total por nombre de periodico //TODO itinerate through media
		//console.log(totalday);
		//var total[key] = test[key]["Total"];
		for (var key in totalday) { //TODO flter by period
			//console.log(key,totalday[key]);
			//TODO convert in array of parties and iterate with foreach and i
			var coverage = totalday[key];
			for ( var i = 0; i < parties.length; i++ ) {
				if (key == parties[i] ) {
					//console.log('itinerando: ', i, theDay, parties[i] ,coverage);
					var date = new Date(theDay);
					//console.log("mes: ", date.getMonth()+1);
					//var dd = new Date();
					//console.log(dd);
					var newElement = {};
					newElement.y = coverage;
					newElement.date = theDay;
					newElement.party = parties[i];
					newElement.month = date.getMonth();
					newElement.year = date.getFullYear();
					total[i].push(newElement);
				}
			}
			/*if (key == 'PP') {
				//console.log(theDay, 'PP',totalday[key]);
				//total[1][i] = totalday[key];
				var newElement = {};
				newElement.y = totalday[key];
				newElement.date = theDay;
				newElement.party = 'PP';
				total[0].push(newElement);
			}*/
		}
	}
}

console.log(total);
for ( var i = 0; i < total.length; i++ ){
	total[i].sort(function(a,b){
		// Turn your strings into dates, and then subtract them
		// to get a value that is either negative, positive, or zero.
		return new Date(a.date) - new Date(b.date);
	});
}
console.log("total[0]",total[0]);

var years = ['2013','2014'];
var sumMonth = [[],[],[],[],[],[],[],[],[],[],[],[]];
var sumYear = [0,0];
var countDays = [0,0];

var stats = [];
for ( var i = 0; i < parties.length; i++ ) {
	stats.push([[],[]]);
}

for ( var a = 0; a < parties.length; a++ ) { //iterate through all the parties
	stats[a].push({"party":parties[a]});
	for ( var b = 0; b < years.length; b++ ) {//iterate through years
		stats[a][b].push({"year":years[b]});
		var newElement = {}; //creates an element per party
		sumYear[b] = 0;
		countDays[b] = 0;
		newElement.year = years[b];
		sumMonth = [0,0,0,0,0,0,0,0,0,0,0,0];
		for ( var i = 0; i < total[0].length; i++ ) { //iterate through all the days i
			if ( total[a][i]['year'] == years[b] ) {//values for year 2014 TODO iterate through years and store the value
				//sum2014 += total[a][i]['y']; //total[0] is PP
				//i2014++; //counts days in 2014
				sumYear[b] += total[a][i]['y'];
				countDays[b]++;
				m = parseFloat(total[a][i]['month']);
				sumMonth[m] += total[a][i]['y'];
			}
				//console.log(countDays[b]);
				//sum2013 += total[a][i]['y'];
				//days2013++;
			//} else { //values for year 2013
				//sum2014 += total[a][i]['y']; //total[0] is PP
				//days2014++;
				//for ( var m = 0; m < 12; m++ ) {
				
					//if (total[a][i]['month'] == m) {
				
					//}
						//month = total[a][i]['month'];
				//}
				/*if (total[a][i]['month'] == '0') {//TODO loop through months
					sum11 += total[a][i]['y'];
				}
				if (total[a][i]['month'] == '11') {//TODO loop through months
					sum12 += total[a][i]['y'];
				}*/
			//}
			//}
		}
		
		newElement.sumYear = sumYear[b];
		newElement.sumMonth = sumMonth;
		newElement.daysPerYear = countDays[b];
		newElement.avgYear = sumYear[b]/countDays[b];
		newElement.party = parties[a];
		//newElement.sum11 = sum11;
		//newElement.sum201411 = sum201411;
		//newElement.year = date.getFullYear();
		stats[a][b].push(newElement); //pushes and elenmen per party
	}
	
}

console.log("stats:", stats);

var perYear = [];
for ( var i = 0; i < parties.length; i++ ) {
	perYear.push([[],[]]);
}

for (var i = 0; i < stats.length; i++) {
	for (var j = 0; j < years.length; j++) {
		perYear[i][j] = stats[i][j][1]['avgYear'];
	}
}
console.log("perYear",perYear);

var perMonth = [];
for ( var i = 0; i < parties.length; i++ ) {
	perMonth.push([]);
}
for (var i = 0; i < stats.length; i++) { //per party
	for (var j = 0; j < years.length; j++) { //per year
		var everyMonth = [];
		everyMonth.push(stats[i][j][1]['sumMonth']); //value of one party in one month
		//console.log(stats[i][j][1]['sumMonth']);
		perMonth[i].push(everyMonth);
	}
}
console.log("perMonth",perMonth);

perMonthFinal = [];
for ( var i = 0; i < parties.length; i++ ) {
	perMonthFinal.push([]);
}

for (var key = 0; key < stats.length; key++) {
	for (var i = 0; i < 12; i++) {
		perMonthFinal[key].push({"y":perMonth[key][0][0][i]});
		//perMonthFinal.push(perMonth[key][0][0]);
		perMonthFinal[key] = perMonthFinal[key].concat({"y":perMonth[key][1][0][i]});
	}
}
console.log("perMonthFinal",perMonthFinal);

//Convert an object to file
/*var printThis = JSON.stringify(perMonthFinal); //convert object to string
var url = 'data:text/json;charset=utf8,' + encodeURIComponent(printThis); //saves file
window.open(url, '_blank');
window.focus();*/
});
    </script>
  </body>
</html>

