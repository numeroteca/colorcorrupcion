<!DOCTYPE html>
<html>
  <head>
		<title>PageOneX Color Corrupci&oacute;n</title>
		<script type="text/javascript" src="http://mbostock.github.com/d3/d3.js?1.29.1"></script>
		<script type="text/javascript" src="http://mbostock.github.com/d3/d3.layout.js?1.29.1"></script>
		<script type="text/javascript" src="http://mbostock.github.com/d3/d3.time.js?1.29.1"></script>
		<script type="text/javascript" src="http://mbostock.github.com/d3/d3.csv.js?1.29.1"></script>
		<script type="text/javascript" src="http://code.jquery.com/jquery-1.10.2.js"></script>
		<script src="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
		<link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
		<style type="text/css">

		svg {
			width: 1500px;
			height: 400px;
			border: solid 1px #ccc;
			font: 10px sans-serif;
			shape-rendering: crispEdges;
		}
		rect:hover {
			cursor:pointer;
			
			opacity: 0.4;
		}

    </style>
  </head>
  <body>
  	<h1>El Color de la Corrupci&oacute;n
			<small>
				<span class="label label-default" style="background-color:blue">PP</span> 
				<span class="label label-default" style="background-color:red">PSOE</span> 
				<span class="label label-default" style="background-color:orange">CiU</span> 
				<span class="label label-default" style="background-color:darkgreen">Casa Real</span> 
				<span class="label label-default" style="background-color:lime">Bankia</span> 
				<span class="label label-default" style="background-color:#FBBBB9">UGT-A y CCOO</span> 
				<span class="label label-default" style="background-color:grey">Otros</span> 
			</small>
  	</h1>
  	<p>Cobertura de corrupci&oacute;n en portadas</p>
		<div class="btn-group">
				<button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown">
					 Selecciona peri&oacute;dico <span class="caret"></span>
 				</button>
				<ul class="dropdown-menu" role="menu">
					<li><a class="m" value="Total" href="#">Media de todos los peri&oacute;dicos</a></li>
 					<li><a class="m" value="El Pais" href="#">El Pa&iacute;s</a></li>
 					<li><a class="m" value="El Mundo" href="#">El Mundo</a></li>
  				<li><a class="m" value="ABC" href="#">ABC</a></li>
  				<li><a class="m" value="La Razon" href="#">La Raz&oacute;n</a></li>
  				<li><a class="m" value="La Gaceta" href="#">La Gaceta</a></li>
  				<li><a class="m" value="La Vanguardia" href="#">La Vanguardia</a></li>
  				<li><a class="m" value="El Periodico" href="#">El Peri&oacute;dico</a></li>
  				<li><a class="m" value="Ara" href="#">Ara</a></li>
			</ul>
		</div>
					
    <script type="text/javascript">
//On click, update with new data

//initially based on http://bl.ocks.org/mbostock/1134768 and http://bl.ocks.org/anupsavvy/9513382
var w = 1500,
    h = 400,
    p = [20, 50, 30, 20],
    x = d3.scale.ordinal().rangeRoundBands([0, w - p[1] - p[3]]), //https://github.com/mbostock/d3/wiki/Ordinal-Scales#ordinal_rangeRoundBands
    y = d3.scale.linear().range([0, h - p[0] - p[2]]),
    colors = ["blue", "red", "orange","darkgreen","lime","#FBBBB9","grey"],
    color = d3.scale.ordinal().range(colors),
    parties = ['PP','PSOE','CiU','Casa Real','Bankia','UGT-A y CCOO','Otros'];
    //parties = {'PP':"blue",'PSOE':"red",'CiU':"orange",'Casa Real':"darkgreen",'Bankia':"lime",'UGT-A y CCOO':"#FBBBB9",'Otros':"grey};
    //parse = d3.time.format("%m-%Y").parse,
    format = d3.time.format("%b");
    //parse = d3.time.format("%Y-%m-%d").parse

var svg = d3.select("body").append("svg:svg")
    .attr("width", w)
    .attr("height", h)
  .append("svg:g")
    .attr("transform", "translate(" + p[3] + "," + (h - p[2]) + ")");

//Set up stack method
var stack = d3.layout.stack();

console.log("aaa");

var str = "data/perMonthElMundo.json";	
console.log("str",str);

//On click, update with new data
d3.selectAll(".m").on("click", function() {
	var date = this.getAttribute("value");
	//console.log("this",this.getAttribute("value"));
	console.log("date",date);
	var str = "data/perMonthElMundo.json";
	console.log("str 0",str);
	if(date == "El Pais"){
		str = "data/perMonthElPais.json";
	}else if(date == "El Mundo"){
		str = "data/perMonthElMundo.json";
	}else if(date == "ABC"){
		str = "data/perMonthABC.json";
	}else if(date == "La Razon"){
		str = "data/perMonthLaRazon.json";
	}else if(date == "La Gaceta"){
		str = "data/perMonthLaGaceta.json";
	}else if(date == "La Vanguardia"){
		str = "data/perMonthLaVanguardia.json";
	}else if(date == "El Periodico"){
		str = "data/perMonthElPeriodico.json";
	}else if(date == "Ara"){
		str = "data/perMonthAra.json";
	}else if(date == "Total"){
		str = "data/perMonthTotal.json";
	}else{
		str = "data/perMonthLaVanguardia.json";
	}
	console.log("str 1",str);


//d3.csv("crimea.csv", function(crimea) {
d3.json(str, function(total) { //Reads json file 'data/perMonthElMundo.json'

console.log(total);
console.log("total['data']",total);

media = total['media'];
console.log("media",media);

total = total['data'];
for ( var i = 0; i < total.length; i++ ){
	total[i].sort(function(a,b){
		// Turn your strings into dates, and then subtract them
		// to get a value that is either negative, positive, or zero.
		return new Date(a.date) - new Date(b.date);
	});
}
console.log("total prev",total);

//For json
dataset = total;
stack(dataset);
console.log("stack(dataset) ",dataset);

// Compute the x-domain (by date) and y-domain (by top).
x.domain(	dataset[0].map(function(d) { return d.x; }) ); //coge la primera de las n arrays, podÅ•ia ser 1 o 2 tambien
y.domain([
	0, //valor minimo
	14 //TODO calculate the max value (y0) of all the possible arrays to keep y scale constant
	/*d3.max(
		dataset[dataset.length - 1], function(d) { return d.y0 + d.y; console.log(d.y0 + d.y);} //coge la array ultima que ya tienen todos los valors acumulados
	) */ //valor maximo
]); //usa la ultima array, la que tiene los valores de las otras ya acumulados para calcular el maximos valos de y


/*var xAxis = d3.svg.axis()
				   .scale(x)
				   .orient("bottom")
				   .ticks(24)
				   .tickFormat(d3.time.format("%b"));
   
d3.append("g")
	.attr("class","x axis")
	.attr("transform","translate(40," + (0) + ")")
	.call(xAxis);*/
var formato = d3.time.format("%m-%Y");

svg.selectAll("text")
   .data(dataset[0])
   .enter()
   .append("text")
   .text(function(d) {
        //return d.x;
        return formato(new Date(d.x));
        //return x(d) + x.rangeBand() / 2;
        //return "xx";
   })
   .attr("x", function(d, i) {
        //return i * (w / dataset[0].length);
        return x(d.x);
   })
   .attr("y", 15);

groups = svg.selectAll(".cause").data(dataset);
groups.enter().append("g")
        .attr("class","cause")
        .style("fill",function(d,i) {
            return color(i);
        });

groups.selectAll("rect").data(function(d){return d;}).remove();

rect = groups.selectAll("rect").data(function(d){return d;});



rect.enter()
  .append("rect")
  //.attr("x",function(d,i) { return i*w/dataset[0].length-20; })
  .attr("x", function(d) { return x(d.x); })
  .attr("y", function(d) { return -y(d.y0) - y(d.y); })
  .attr("width",(w - p[1] - p[3])/(dataset[0].length*1.15))
  .attr("height", function(d) { return y(d.y); })
  .attr("title",function(d) { return d.party + ": " + d.y.toPrecision(3) + "\nMes: " + formato(new Date(d.x)); })
  .style("fill-opacity",1);

legend = svg.selectAll("rect");

var legend = svg.append("rect")
  //.attr("x",function(d,i) { return i*w/dataset[0].length-20; })
  .attr("x", function(d,i) { return i*10; })
  .attr("y", function(d,i) { return h; })
  .attr("width",20)
  .attr("height",20)
  .attr("fill","#f00")
  .style("fill-opacity",1);

  // Add a label per date.
  var label = svg.selectAll("text")
      .data(x.domain())
    .enter().append("svg:text")
      .attr("x", function(d) { return x(d) + x.rangeBand() / 2; })
      //.attr("x",function(d,i) { return i*w/dataset[0].length-20; })
      .attr("y", 6)
      .attr("text-anchor", "middle")
      .attr("dy", ".71em")
      //.text(function(d) { return month(d); });
      //.text(format());
      .text("-");

  // Add y-axis rules.
  var rule = svg.selectAll("g.rule")
      .data(y.ticks(5))
    .enter().append("svg:g")
      .attr("class", "rule")
      .attr("transform", function(d) { return "translate(0," + -y(d) + ")"; });

  rule.append("svg:line")
      .attr("x2", w - p[1] - p[3])
      .style("stroke", function(d) { return d ? "#fff" : "#000"; })
      .style("stroke-opacity", function(d) { return d ? .7 : null; });

  rule.append("svg:text")
      .attr("x", w - p[1] - p[3] + 6)
      .attr("dy", ".35em")
      .text(d3.format(",d"));
  
	d3.select(".medianame").remove();
  
  var mediaName = svg.append("svg:text")
    .attr("x", 0)
    .attr("y", -h + p[0] + 30)
    .attr("dy", "1em")
    .attr("class", "medianame")
    .attr("text-anchor", "right")
    .style("font-size","16px")
    .text(media);
});
console.log("str 2",str);
});//end on click
	 
    </script>
  </body>
</html>

